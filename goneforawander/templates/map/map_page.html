{% extends "base.html" %}
{% load static wagtailimages_tags wagtailcore_tags map_tags %}
{% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://api.mapbox.com/mapbox-gl-js/{{ mapbox.api_version }}/mapbox-gl.css"
          type="text/css">
    <link rel="stylesheet"
          href="{% static 'mapbox-assist/css/mapbox-assist.css' %}"
          type="text/css">
    {% if self.map_settings.extra_head %}{{ self.map_settings.extra_head|parse_django_template }}{% endif %}
    <style>
        div#map {
            width: 100%; height: 70vh;
        }
    </style>
{% endblock extra_head %}
{% block content %}
    <article class="article-body mb-4">
        <h1>{{ self.title }}</h1>
        <div id="map"></div>
    </article>
    <template id="help-content">
        <div class="mapbox-assist--offcanvas-header">{{ self.help_panel_title|safe }}</div>
        <div class="mapbox-assist--offcanvas-body mt-2">{{ self.help_panel_body|richtext }}</div>
    </template>
{% endblock content %}
{% block extra_js %}
    {{ self.parameters|json_script:"mapParameters" }}
    {{ self.settings|json_script:"mapSettings" }}
    <script type="importmap">
        {
            "imports": {
                "mapbox-gl": "https://esm.sh/mapbox-gl@{{ mapbox.api_version}}"
            }
        }
    </script>
    <script type="module">
        import mapboxgl from 'mapbox-gl';
        import { MapboxAssist } from '/static/mapbox-assist/js/mapbox-assist.esm.js';
        {% if self.map_settings.feature_layers.layers %}
            {{ self.map_settings.feature_layers|import_feature_layer_js }}
        {% endif %}

        const mapParameters = JSON.parse(document.getElementById('mapParameters').textContent);
        const mapSettings = JSON.parse(document.getElementById('mapSettings').textContent);

        try {
            mapboxgl.accessToken = '{{ self.map_settings.token}}';
            const mapboxAssist = new MapboxAssist(mapParameters, mapSettings);

        } catch (error) {
            console.error('Error initializing MapboxAssist:', error);
        }
    </script>
{% endblock extra_js %}
