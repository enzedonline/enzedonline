{% extends "base.html" %}
{% load static wagtailimages_tags wagtailcore_tags map_tags %}
{% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://api.mapbox.com/mapbox-gl-js/v{{ mapbox.api_version }}/mapbox-gl.css"
          type="text/css">
    <link rel="stylesheet"
          href="{% static 'css/mapbox-assist.css' %}"
          type="text/css">
    {% if extra_head %}{{ extra_head|parse_django_template }}{% endif %}
    <style>
        div#map {
            width: 100%; height: 70vh;
        }
    </style>
{% endblock extra_head %}
{% block content %}
    <div id="content" class="container-fluid mt-3 px-3 px-sm-5">
        <article class="article-body mb-4">
            <h1>{{ self.title }}</h1>
            <div id="map"></div>
        </article>
    </div>
    <template id="help-content">
        <div class="mapbox-assist--offcanvas-header">{{ help.title|safe }}</div>
        <div class="mapbox-assist--offcanvas-body mt-2">{{ help.body|richtext }}</div>
    </template>
{% endblock content %}
{% block extra_js %}
    {{ parameters|json_script:"mapParameters" }}
    {{ mapboxAssistSettings|json_script:"mapboxAssistSettings" }}
    <script type="importmap">
        {
            "imports": {
                "mapbox-gl": "https://esm.sh/mapbox-gl@v{{ mapbox.api_version}}"
            }
        }
    </script>
    <script type="module">
        import mapboxgl from 'mapbox-gl'
        import { MapboxAssist } from "{% static 'js/mapbox-assist.esm.js' %}";
        const mapParameters = JSON.parse(document.getElementById('mapParameters').textContent);
        const mapSettings = JSON.parse(document.getElementById('mapboxAssistSettings').textContent);
        {% if featureLayers %}
            {{ featureLayers|import_feature_layer_js }}
            mapSettings.featureLayers = { layers: [] };
            {% for layer in featureLayers %}
                mapSettings.featureLayers.layers.push({
                    id: '{{ layer.id }}',
                    tileId: '{{ layer.tileId }}',
                    handler: {{ layer.handler }}
                });
            {% endfor %}
        {% endif %}        

        try {
            mapboxgl.accessToken = '{{ mapbox.token }}';
            const mapboxAssist = new MapboxAssist(mapParameters, mapSettings);

        } catch (error) {
            console.error('Error initializing MapboxAssist:', error);
        }
    </script>
{% endblock extra_js %}
